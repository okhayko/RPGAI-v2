    const generateInitialStory = async (
        worldData: any,
        knownEntities: any,
        pcEntity: any,
        initialHistory: GameHistoryEntry[]
    ) => {
        if (!ai) return;
        setIsLoading(true);
        
        const finalPersonality = worldData.customPersonality || worldData.personalityFromList;
        const writingStyleText = worldData.writingStyle === 'first_person' ? 'NgÃ´i thá»© nháº¥t - NhÃ¢n váº­t chÃ­nh xÆ°ng "Ta/TÃ´i"' : 'NgÃ´i thá»© hai - "NgÆ°Æ¡i" lÃ  nhÃ¢n váº­t chÃ­nh';
        const nsfwInstruction = worldData.allowNsfw ? 'Cho phÃ©p. KÃ­ch hoáº¡t quy táº¯c ná»™i dung 18+ cá»§a Quáº£n TrÃ². Viáº¿t má»™t cÃ¡ch tráº§n trá»¥i, báº¡o lá»±c, tá»¥c tÄ©u vÃ  khÃ´ng giá»›i háº¡n.' : 'KhÃ´ng, AI pháº£i trÃ¡nh cÃ¡c chá»§ Ä‘á» vÃ  mÃ´ táº£ 18+.';
        
        const activeRules = customRules.filter(r => r.isActive);
        let customRulesContext = '';
        if (activeRules.length > 0) {
            customRulesContext = `\n--- TRI THá»¨C & LUáº¬T Lá»† TÃ™Y CHá»ˆNH (ÄANG ÃP Dá»¤NG) ---\n${activeRules.map(r => `- ${r.content}`).join('\n')}\n--- Káº¾T THÃšC ---\n`;
        }

        // BÆ¯á»šC 2: Sá»¬ Dá»¤NG LORE_CONCEPT ÄÃƒ Táº O
        const conceptEntities = Object.values(knownEntities).filter((e: any) => e.type === 'concept');
        let conceptContext = '';
        if (conceptEntities.length > 0) {
            conceptContext = `\n--- CÃC LORE_CONCEPT ÄÃƒ THIáº¾T Láº¬P ---\n${conceptEntities.map((c: any) => `â€¢ ${c.name}: ${c.description}`).join('\n')}\n--- Káº¾T THÃšC ---\n`;
        }

        if (!pcEntity) return;

        // Build skill information with mastery levels and descriptions
        let skillsWithMastery = '';
        if (pcEntity.learnedSkills && pcEntity.learnedSkills.length > 0) {
            const skillDetails = pcEntity.learnedSkills.map((skillName: string) => {
                const skillEntity = knownEntities[skillName];
                if (skillEntity) {
                    const mastery = skillEntity.mastery ? ` (${skillEntity.mastery})` : '';
                    const description = skillEntity.description ? ` - ${skillEntity.description}` : '';
                    return `${skillName}${mastery}${description}`;
                }
                return skillName;
            });
            skillsWithMastery = skillDetails.join('\n  â€¢ ');
        }

        const userPrompt = `${customRulesContext}${conceptContext}

Báº N LÃ€ QUáº¢N TRÃ’ AI. Táº¡o cÃ¢u chuyá»‡n má»Ÿ Ä‘áº§u cho game RPG vá»›i yÃªu cáº§u sau:

--- THÃ”NG TIN NHÃ‚N Váº¬T CHÃNH ---
TÃªn: ${pcEntity.name}
Giá»›i tÃ­nh: ${pcEntity.gender}
Tiá»ƒu sá»­: ${pcEntity.description}
TÃ­nh cÃ¡ch: ${pcEntity.personality}${pcEntity.motivation ? `\n**Äá»˜NG CÆ /Má»¤C TIÃŠU QUAN TRá»ŒNG**: ${pcEntity.motivation}` : ''}${skillsWithMastery ? `\n**Ká»¸ NÄ‚NG KHá»I Äáº¦U**:\n  â€¢ ${skillsWithMastery}` : ''}

--- THÃ”NG TIN THáº¾ GIá»šI ---
Tháº¿ giá»›i: ${worldData.worldName}
MÃ´ táº£: ${worldData.worldDescription}
Thá»i gian: NÄƒm ${worldData.worldTime?.year || 1}, ThÃ¡ng ${worldData.worldTime?.month || 1}, NgÃ y ${worldData.worldTime?.day || 1}
Äá»‹a Ä‘iá»ƒm báº¯t Ä‘áº§u: ${worldData.startLocation === 'Tuá»³ chá»n' ? worldData.customStartLocation : worldData.startLocation || 'KhÃ´ng xÃ¡c Ä‘á»‹nh'}
Phong cÃ¡ch viáº¿t: ${writingStyleText}
Ná»™i dung 18+: ${nsfwInstruction}

--- YÃŠU Cáº¦U VIáº¾T STORY ---
1. **NGÃ”N NGá»® TUYá»†T Äá»I**: Báº®T BUá»˜C 100% tiáº¿ng Viá»‡t. KHÃ”NG dÃ¹ng tiáº¿ng Anh trá»« tÃªn riÃªng nÆ°á»›c ngoÃ i. Quan há»‡ nhÃ¢n váº­t PHáº¢I tiáº¿ng Viá»‡t: "friend"â†’"báº¡n", "enemy"â†’"káº» thÃ¹", "ally"â†’"Ä‘á»“ng minh", "lover"â†’"ngÆ°á»i yÃªu"
2. **CHIá»€U DÃ€I**: ChÃ­nh xÃ¡c 300-400 tá»«, chi tiáº¿t vÃ  sá»‘ng Ä‘á»™ng  
3. **Sá»¬ Dá»¤NG CONCEPT**: Pháº£i tÃ­ch há»£p cÃ¡c LORE_CONCEPT Ä‘Ã£ thiáº¿t láº­p vÃ o cÃ¢u chuyá»‡n má»™t cÃ¡ch tá»± nhiÃªn
4. **THIáº¾T Láº¬P Bá»I Cáº¢NH**: Táº¡o tÃ¬nh huá»‘ng má»Ÿ Ä‘áº§u thÃº vá»‹, khÃ´ng quÃ¡ drama${skillsWithMastery ? `\n5. **NHáº®C Äáº¾N Ká»¸ NÄ‚NG**: Pháº£i Ä‘á» cáº­p hoáº·c thá»ƒ hiá»‡n ká»¹ nÄƒng khá»Ÿi Ä‘áº§u cá»§a nhÃ¢n váº­t trong cÃ¢u chuyá»‡n hoáº·c lá»±a chá»n, chÃº Ã½ Ä‘áº¿n má»©c Ä‘á»™ thÃ nh tháº¡o` : ''}${pcEntity.motivation ? `\n${skillsWithMastery ? '6' : '5'}. **PHáº¢N ÃNH Äá»˜NG CÆ  NHÃ‚N Váº¬T**: CÃ¢u chuyá»‡n vÃ  lá»±a chá»n pháº£i liÃªn quan Ä‘áº¿n Ä‘á»™ng cÆ¡/má»¥c tiÃªu cá»§a nhÃ¢n váº­t chÃ­nh: "${pcEntity.motivation}"` : ''}
${pcEntity.motivation && skillsWithMastery ? '7' : pcEntity.motivation || skillsWithMastery ? '6' : '5'}. **TIME_ELAPSED**: Báº¯t buá»™c sá»­ dá»¥ng [TIME_ELAPSED: hours=0] 
${pcEntity.motivation && skillsWithMastery ? '8' : pcEntity.motivation || skillsWithMastery ? '7' : '6'}. **THáºº Lá»†NH**: Táº¡o Ã­t nháº¥t 2-3 tháº» lá»‡nh phÃ¹ há»£p (LORE_LOCATION, LORE_NPC, STATUS_APPLIED_SELF...)
${pcEntity.motivation && skillsWithMastery ? '9' : pcEntity.motivation || skillsWithMastery ? '8' : '7'}. **Lá»°A CHá»ŒN**: Táº¡o 4-6 lá»±a chá»n hÃ nh Ä‘á»™ng Ä‘a dáº¡ng vÃ  thÃº vá»‹${pcEntity.motivation ? `, má»™t sá»‘ lá»±a chá»n pháº£i hÆ°á»›ng tá»›i viá»‡c thá»±c hiá»‡n má»¥c tiÃªu: "${pcEntity.motivation}"` : ''}${skillsWithMastery ? `, vÃ  má»™t sá»‘ lá»±a chá»n cho phÃ©p sá»­ dá»¥ng ká»¹ nÄƒng khá»Ÿi Ä‘áº§u vá»›i má»©c Ä‘á»™ thÃ nh tháº¡o phÃ¹ há»£p` : ''}

HÃ£y táº¡o má»™t cÃ¢u chuyá»‡n má»Ÿ Ä‘áº§u cuá»‘n hÃºt${pcEntity.motivation ? ` vÃ  thá»ƒ hiá»‡n rÃµ Ä‘á»™ng cÆ¡ "${pcEntity.motivation}" cá»§a nhÃ¢n váº­t` : ''}${skillsWithMastery ? `${pcEntity.motivation ? ', ' : ' vÃ  '}nháº¯c Ä‘áº¿n hoáº·c cho phÃ©p sá»­ dá»¥ng ká»¹ nÄƒng khá»Ÿi Ä‘áº§u vá»›i má»©c Ä‘á»™ thÃ nh tháº¡o` : ''}!

**LÆ¯U Ã CUá»I CÃ™NG**: Kiá»ƒm tra ká»¹ lÆ°á»¡ng toÃ n bá»™ output Ä‘á»ƒ Ä‘áº£m báº£o 100% tiáº¿ng Viá»‡t, khÃ´ng cÃ³ tá»« tiáº¿ng Anh nÃ o!`;

        const finalHistory: GameHistoryEntry[] = [{ role: 'user', parts: [{ text: userPrompt }] }];
        setGameHistory(finalHistory);

        try {
            console.log('ğŸ“– GenerateInitialStory: Making AI request with model:', selectedModel);
            console.log('ğŸ“– GenerateInitialStory: System instruction length:', systemInstruction.length);
            console.log('ğŸ“– GenerateInitialStory: Initial history:', finalHistory);
            
            const response = await ai.models.generateContent({
                model: selectedModel, 
                contents: finalHistory,
                config: { 
                    systemInstruction: systemInstruction, 
                    responseMimeType: "application/json", 
                    responseSchema: responseSchema 
                }
            });
            
            console.log('ğŸ“– GenerateInitialStory: AI response received:', {
                hasText: !!response.text,
                textLength: response.text?.length || 0,
                usageMetadata: response.usageMetadata
            });
            
            const turnTokens = response.usageMetadata?.totalTokenCount || 0;
            setCurrentTurnTokens(turnTokens);
            setTotalTokens(prev => prev + turnTokens);

            const responseText = response.text?.trim() || '';
            
            if (!responseText) {
                console.error("ğŸ“– GenerateInitialStory: API returned empty response text", {
                    responseMetadata: response.usageMetadata,
                    model: selectedModel,
                    responseObject: response
                });
                
                // Check for specific error conditions
                let errorMessage = "Lá»—i: AI khÃ´ng thá»ƒ táº¡o cÃ¢u chuyá»‡n khá»Ÿi Ä‘áº§u.";
                
                if (response.usageMetadata?.totalTokenCount === 0) {
                    errorMessage += " CÃ³ thá»ƒ do giá»›i háº¡n token hoáº·c ná»™i dung bá»‹ lá»c.";
                } else if (!response.usageMetadata) {
                    errorMessage += " CÃ³ thá»ƒ do lá»—i káº¿t ná»‘i máº¡ng.";
                }
                
                errorMessage += " Vui lÃ²ng thá»­ táº¡o láº¡i tháº¿ giá»›i hoáº·c kiá»ƒm tra API key.";
                
                storyLogManager.update(prev => [...prev, errorMessage]);
                setChoices([]);
                return;
            }
            
            console.log('ğŸ“– GenerateInitialStory: Response text received, length:', responseText.length);
            parseApiResponseHandler(responseText);
            setGameHistory(prev => [...prev, { role: 'model', parts: [{ text: responseText }] }]);
        } catch (error: any) {
            console.error("ğŸ“– GenerateInitialStory: Error occurred:", {
                errorMessage: error.message,
                errorString: error.toString(),
                errorStack: error.stack,
                errorType: typeof error,
                isUsingDefaultKey,
                userApiKeyCount
            });
            
            if (!isUsingDefaultKey && userApiKeyCount > 1 && error.toString().includes('429')) {
                console.log("ğŸ“– GenerateInitialStory: Rate limit detected, rotating key...");
                rotateKey();
                storyLogManager.update(prev => [...prev, "**â­ Lá»—i giá»›i háº¡n yÃªu cáº§u. ÄÃ£ tá»± Ä‘á»™ng chuyá»ƒn sang API Key tiáº¿p theo. Vui lÃ²ng thá»­ láº¡i hÃ nh Ä‘á»™ng cá»§a báº¡n. â­**"]);
                setChoices(rehydratedChoices);
            } else {
                console.error("ğŸ“– GenerateInitialStory: Non-rate-limit error, showing error message");
                storyLogManager.set(["CÃ³ lá»—i xáº£y ra khi báº¯t Ä‘áº§u cÃ¢u chuyá»‡n. Vui lÃ²ng thá»­ láº¡i.", `Chi tiáº¿t lá»—i: ${error.message || error.toString()}`]);
            }
        } finally {
            console.log("ğŸ“– GenerateInitialStory: Cleaning up, setting loading false");
            setIsLoading(false);
        }
    };